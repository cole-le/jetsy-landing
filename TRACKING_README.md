# Jetsy Enhanced Analytics & Tracking System

## Overview

This enhanced tracking system provides comprehensive analytics for both the main Jetsy website and websites generated by Jetsy. It stores all tracking data in Cloudflare D1 database, offering better privacy, control, and automation compared to Google Analytics.

## Key Features

### 🎯 **Comprehensive Event Tracking**
- Button clicks, form submissions, page views
- User engagement (scroll depth, time on page)
- Conversion funnel tracking
- Performance metrics
- Error tracking

### 🔄 **Automatic Tracking**
- Auto-detects and tracks common user interactions
- Session management with unique session IDs
- Performance monitoring
- External link tracking

### 🏗️ **Jetsy Integration Ready**
- Specialized tracking for generated websites
- Website-specific analytics
- User attribution
- Automated snippet injection

### 📊 **Rich Analytics Dashboard**
- Real-time metrics visualization
- Date range filtering
- Growth calculations
- Detailed data tables

## Database Schema

### Core Tables

#### `tracking_events`
Stores all tracking events with enhanced metadata:
```sql
- event_name: Name of the tracked event
- event_category: 'user_interaction', 'conversion', 'engagement', 'error', 'performance'
- event_data: JSON string with event-specific data
- session_id: Groups events by user session
- website_id: For Jetsy-generated websites
- user_id: For Jetsy-generated websites
- jetsy_generated: Boolean flag for generated sites
```

#### `jetsy_websites`
Tracks websites created by Jetsy:
```sql
- website_id: Unique identifier
- user_id: Jetsy user who created the website
- website_name: Human-readable name
- template_type: 'landing_page', 'ecommerce', 'portfolio'
- status: 'active', 'inactive', 'deleted'
```

#### `user_sessions`
Session management for better user journey tracking:
```sql
- session_id: Unique session identifier
- website_id: Associated website (if any)
- duration_ms: Session duration
- page_views: Number of page views
- events_count: Total events in session
```

#### `conversion_funnels`
Multi-step conversion tracking:
```sql
- funnel_name: 'lead_generation', 'purchase', 'signup'
- step_name: Current step in funnel
- step_order: Sequential order
- step_data: JSON with step-specific data
```

## API Endpoints

### `/api/track` (POST)
General tracking endpoint for the main Jetsy site.

**Request Body:**
```json
{
  "event": "button_click",
  "data": {
    "button": "signup_button",
    "category": "conversion"
  },
  "timestamp": 1640995200000,
  "userAgent": "Mozilla/5.0...",
  "url": "https://jetsy.com",
  "category": "user_interaction",
  "sessionId": "session_123456",
  "pageTitle": "Jetsy - Landing Page",
  "referrer": "https://google.com"
}
```

### `/api/jetsy-analytics` (POST)
Specialized endpoint for Jetsy-generated websites.

**Request Body:**
```json
{
  "websiteId": "website_123",
  "userId": "user_456",
  "sessionId": "session_789",
  "event": "page_view",
  "data": {
    "page": "/home",
    "page_load_time": 1200
  },
  "timestamp": 1640995200000,
  "userAgent": "Mozilla/5.0...",
  "url": "https://generated-site.com",
  "category": "page_view",
  "pageTitle": "My Generated Site",
  "referrer": "https://jetsy.com",
  "jetsyGenerated": true
}
```

### `/api/analytics` (GET)
Retrieve analytics data for dashboard.

**Query Parameters:**
- `start_date`: Start date (YYYY-MM-DD)
- `end_date`: End date (YYYY-MM-DD)
- `website_id`: Filter by specific website
- `event_type`: Filter by event type

## Frontend Integration

### For Main Jetsy Site

Use the enhanced analytics utility:

```javascript
import { 
  trackEvent, 
  trackButtonClick, 
  trackFormSubmit, 
  trackEngagement,
  trackFunnelStep,
  initializeAutoTracking 
} from './utils/analytics'

// Initialize auto-tracking
initializeAutoTracking()

// Manual tracking
trackButtonClick('signup_button', 'conversion', { plan: 'pro' })
trackFormSubmit('lead_form', { email: 'user@example.com' }, { hasErrors: false })
trackEngagement('scroll_depth', 75)
trackFunnelStep('lead_capture', { stepNumber: 2, completionPercentage: 50 })
```

### For Jetsy-Generated Websites

Automatically inject the tracking snippet:

```javascript
// jetsy-tracking-snippet.js
// This snippet is automatically injected into generated websites

window.JetsyAnalytics = {
  track: trackEvent,
  trackPageView: (pageName) => trackEvent('page_view', { page: pageName }),
  trackButtonClick: (buttonName, additionalData = {}) => 
    trackEvent('button_click', { button: buttonName, ...additionalData }),
  trackFormSubmit: (formName, additionalData = {}) => 
    trackEvent('form_submit', { form: formName, ...additionalData }),
  trackConversion: (conversionType, additionalData = {}) => 
    trackEvent('conversion', { type: conversionType, ...additionalData })
}

// Usage in generated websites:
JetsyAnalytics.trackButtonClick('contact_form_submit')
JetsyAnalytics.trackConversion('lead_generated', { source: 'contact_form' })
```

## Analytics Dashboard

The `AnalyticsDashboard` component provides:

- **Key Metrics Cards**: Page views, funnel completions, conversions, performance
- **Growth Indicators**: Percentage change vs previous period
- **Interactive Charts**: Visual representation of metrics over time
- **Detailed Data Table**: Raw data with filtering options
- **Date Range Selection**: 7, 30, or 90-day views
- **Website-Specific Views**: Filter by specific generated websites

## Implementation for Jetsy

### 1. Website Generation Process

When Jetsy generates a website:

1. **Create Website Record**:
```javascript
await db.prepare(
  "INSERT INTO jetsy_websites (website_id, user_id, website_name, template_type, created_at) VALUES (?, ?, ?, ?, ?)"
).bind(websiteId, userId, websiteName, templateType, currentTime).run()
```

2. **Inject Tracking Snippet**:
```javascript
const trackingSnippet = fs.readFileSync('src/utils/jetsy-tracking-snippet.js', 'utf8')
  .replace('{{WEBSITE_ID}}', websiteId)
  .replace('{{USER_ID}}', userId)
```

3. **Add to Generated HTML**:
```html
<script>
  // Injected tracking snippet with website-specific config
</script>
```

### 2. Analytics Dashboard Integration

Add analytics dashboard to Jetsy admin:

```javascript
// In Jetsy admin panel
<AnalyticsDashboard websiteId={selectedWebsiteId} />
```

### 3. Automated Insights

Set up automated reports:

```javascript
// Daily/weekly reports for website owners
const generateReport = async (websiteId, dateRange) => {
  const analytics = await fetch(`/api/analytics?website_id=${websiteId}&start_date=${startDate}&end_date=${endDate}`)
  // Generate insights and send email
}
```

## Benefits Over Google Analytics

### ✅ **Privacy-First**
- No third-party tracking
- Data stored in your own database
- GDPR compliant by design

### ✅ **Better Control**
- Custom event definitions
- Real-time data access
- No sampling limitations

### ✅ **Automation Ready**
- Automatic snippet injection
- Website-specific tracking
- Integrated with Jetsy workflow

### ✅ **Cost Effective**
- No per-user charges
- No data volume limits
- Predictable pricing

### ✅ **Developer Friendly**
- Simple API
- JSON-based data structure
- Easy to extend and customize

## Future Enhancements

### Planned Features

1. **Real-time Analytics**
   - WebSocket connections for live updates
   - Live visitor tracking

2. **Advanced Segmentation**
   - User behavior cohorts
   - Geographic segmentation
   - Device type analysis

3. **A/B Testing Integration**
   - Variant tracking
   - Statistical significance calculations
   - Automated winner selection

4. **Predictive Analytics**
   - Conversion probability scoring
   - Churn prediction
   - Revenue forecasting

5. **Export Capabilities**
   - CSV/Excel exports
   - API for external tools
   - Webhook integrations

## Getting Started

1. **Update Database Schema**:
```bash
# Apply the new schema
wrangler d1 execute jetsy-leads --file=schema.sql
```

2. **Deploy Updated Worker**:
```bash
wrangler deploy
```

3. **Test Tracking**:
```bash
# Test the tracking endpoint
curl -X POST https://your-domain.com/api/track \
  -H "Content-Type: application/json" \
  -d '{"event":"test_event","data":{"test":true}}'
```

4. **View Analytics**:
Navigate to your analytics dashboard to see the data in action.

## Support

For questions or issues with the tracking system:

1. Check the console for error messages
2. Verify database schema is up to date
3. Test API endpoints directly
4. Review network requests in browser dev tools

The tracking system is designed to be robust and fail gracefully, so even if tracking fails, your website functionality won't be affected. 